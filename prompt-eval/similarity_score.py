import torch
from transformers import CLIPProcessor, CLIPModel
import pandas as pd
import lpips
from PIL import Image
import os
from torchvision import transforms
import json

current_dir = os.path.dirname(os.path.abspath(__file__))
dataset_path = os.path.join(current_dir, 'dataset')
image_folder = os.path.join(dataset_path, 'images')
captions_file = os.path.join(dataset_path, 'captions.txt')
model = CLIPModel.from_pretrained("openai/clip-vit-base-patch32")
processor = CLIPProcessor.from_pretrained("openai/clip-vit-base-patch32")
device = torch.device("cuda" if torch.cuda.is_available() else "cpu")
model.to(device)

lpips_loss_fn = lpips.LPIPS(net='alex')
lpips_loss_fn.to(device)

def load_image(image_path):
    transform = transforms.Compose([
        transforms.Resize((224, 224)),
        transforms.ToTensor()
    ])
    image = Image.open(image_path).convert('RGB')
    return transform(image).unsqueeze(0).to(device)

captions_df = pd.read_csv(captions_file, header=None, names=['file_name', 'caption'])

input_text = "A dog catches a red ball in mid-air near a lake."

input_image_path = os.path.join(current_dir, "3k_img1.png")
input_image = load_image(input_image_path)

dataset_image_names = [
    # Dataset 1
    ["1000268201_693b08cb0e.jpg", "1001773457_577c3a7d70.jpg", "1002674143_1b742ab4b8.jpg", "1003163366_44323f5815.jpg", "1007129816_e794419615.jpg", "1007320043_627395c3d8.jpg", "1009434119_febe49276a.jpg", "1012212859_01547e3f17.jpg", "1015118661_980735411b.jpg", "1015584366_dfcec3c85a.jpg", "101654506_8eb26cfb60.jpg", "101669240_b2d3e7f17b.jpg", "1016887272_03199f49c4.jpg", "1019077836_6fc9b15408.jpg", "1019604187_d087bf9a5f.jpg", "1020651753_06077ec457.jpg", "1022454332_6af2c1449a.jpg", "1022454428_b6b660a67b.jpg", "1022975728_75515238d8.jpg", "102351840_323e3de834.jpg", "1024138940_f1fefbdce1.jpg", "102455176_5f8ead62d5.jpg", "1026685415_0431cbf574.jpg", "1028205764_7e8df9a2ea.jpg", "1030985833_b0902ea560.jpg", "103106960_e8a41d64f8.jpg", "103195344_5d2dc613a3.jpg", "103205630_682ca7285b.jpg", "1032122270_ea6f0beedb.jpg", "1032460886_4a598ed535.jpg", "1034276567_49bb87c51c.jpg", "104136873_5b5d41be75.jpg", "1042020065_fb3d3ba5ba.jpg", "1042590306_95dea0916c.jpg", "1045521051_108ebc19be.jpg", "1048710776_bb5b0a5c7c.jpg", "1052358063_eae6744153.jpg", "105342180_4d4a40b47f.jpg", "1053804096_ad278b25f1.jpg", "1055623002_8195a43714.jpg", "1055753357_4fa3d8d693.jpg", "1056249424_ef2a2e041c.jpg", "1056338697_4f7d7ce270.jpg", "1056359656_662cee0814.jpg", "1056873310_49c665eb22.jpg", "1057089366_ca83da0877.jpg", "1057210460_09c6f4c6c1.jpg", "1057251835_6ded4ada9c.jpg", "106490881_5a2dd9b7bd.jpg", "106514190_bae200f463.jpg", "1067180831_a59dc64344.jpg", "1067675215_7336a694d6.jpg", "1067790824_f3cc97239b.jpg", "1072153132_53d2bb1b60.jpg", "107318069_e9f2ef32de.jpg", "1075716537_62105738b4.jpg", "107582366_d86f2d3347.jpg", "1075867198_27ca2e7efe.jpg", "1075881101_d55c46bece.jpg", "1077546505_a4f6c4daa9.jpg", "1077931201_1e0bb83105.jpg", "1079274291_9aaf896cc1.jpg", "10815824_2997e03d76.jpg", "1082252566_8c79beef93.jpg", "1082379191_ec1e53f996.jpg", "1084040636_97d9633581.jpg", "1084104085_3b06223afe.jpg", "1087168168_70280d024a.jpg", "1087539207_9f77ab3aaf.jpg", "1088767354_2acee738cf.jpg", "108898978_7713be88fc.jpg", "108899015_bf36131a57.jpg", "1089181217_ee1167f7af.jpg", "1089755335_0bfbfd30e6.jpg", "109202756_b97fcdc62c.jpg", "109202801_c6381eef15.jpg", "109260216_85b0be5378.jpg", "109260218_fca831f933.jpg", "1093716555_801aacef79.jpg", "1093737381_b313cd49ff.jpg", "1094462889_f9966dafa6.jpg", "1095476286_87d4f8664e.jpg", "1095580424_76f0aa8a3e.jpg", "1095590286_c654f7e5a9.jpg", "1095980313_3c94799968.jpg", "1096097967_ac305887b4.jpg", "1096165011_cc5eb16aa6.jpg", "1096395242_fc69f0ae5a.jpg", "109671650_f7bbc297fa.jpg", "109738763_90541ef30d.jpg", "109738916_236dc456ac.jpg", "109823394_83fcb735e1.jpg", "109823395_6fb423a90f.jpg", "109823397_e35154645f.jpg", "1100214449_d10861e633.jpg", "1104133405_c04a00707f.jpg", "1105959054_9c3a738096.jpg", "110595925_f3395c8bd6.jpg", "1107246521_d16a476380.jpg", "1107471216_4336c9b328.jpg"],
    # Dataset 2
    ["1110208841_5bb6806afe.jpg", "1112212364_0c48235fc2.jpg", "111497985_38e9f88856.jpg", "111537217_082a4ba060.jpg", "111537222_07e56d5a30.jpg", "1115565519_d976d4b1f1.jpg", "1115679311_245eff2f4b.jpg", "111766423_4522d36e56.jpg", "1117972841_2b9261f95f.jpg", "1118557877_736f339752.jpg", "1119015538_e8e796281e.jpg", "1119418776_58e4b93eac.jpg", "1119463452_69d4eecd08.jpg", "1121416483_c7902d0d49.jpg", "112178718_87270d9b4d.jpg", "112243673_fd68255217.jpg", "1122944218_8eb3607403.jpg", "1124448967_2221af8dc5.jpg", "1129704496_4a61441f2c.jpg", "1130017585_1a219257ac.jpg", "1130369873_d80a1aa59c.jpg", "1130401779_8c30182e3e.jpg", "1131155939_b4b457b05e.jpg", "1131340021_83f46b150a.jpg", "1131800850_89c7ffd477.jpg", "1131804997_177c3c0640.jpg", "1131932671_c8d17751b3.jpg", "1132772170_600610c5df.jpg", "113678030_87a6a6e42e.jpg", "1138784872_69ade3f2ab.jpg", "114051287_dd85625a04.jpg", "1141718391_24164bf1b1.jpg", "1141739219_2c47195e4c.jpg", "1142283988_6b227c5231.jpg", "1142847777_2a0c1c2551.jpg", "1143373711_2e90b7b799.jpg", "1143882946_1898d2eeb9.jpg", "1144288288_e5c9558b6a.jpg", "1148238960_f8cacec2fc.jpg", "1149179852_acad4d7300.jpg", "114949897_490ca7eaec.jpg", "1151466868_3bc4d9580b.jpg", "1153704539_542f7aa3a5.jpg", "1155138244_859fd6e079.jpg", "115684808_cb01227802.jpg", "1159574340_99ba8c3c59.jpg", "1160034462_16b38174fe.jpg", "1160441615_fe6b3c5277.jpg", "1163282319_b729b24c46.jpg", "116409198_0fe0c94f3b.jpg", "1164131282_b30926f332.jpg", "1164765687_7aca07bbe7.jpg", "1167662968_e466f1e80a.jpg", "1167669558_87a8a467d6.jpg", "1167908324_8caab45e15.jpg", "1169307342_e7a4685a5c.jpg", "1174525839_7c1e6cfa86.jpg", "1174629344_a2e1a2bdbf.jpg", "1176580356_9810d877bf.jpg", "1177994172_10d143cb8d.jpg", "1178705300_c224d9a4f1.jpg", "118187095_d422383c81.jpg", "118309463_a532b75be9.jpg", "1184967930_9e29ce380d.jpg", "1187435567_18173c148b.jpg", "1187593464_ce862352c6.jpg", "1189977786_4f5aaed773.jpg", "1191338263_a4fa073154.jpg", "1193116658_c0161c35b5.jpg", "119534510_d52b3781a3.jpg", "1197800988_7fb0ca4888.jpg", "1198194316_543cc7b945.jpg", "1204996216_71d7519d9a.jpg", "1206506157_c7956accd5.jpg", "1207159468_425b902bfb.jpg", "1211015912_9f3ee3a995.jpg", "1213336750_2269b51397.jpg", "1215334959_b1970965f7.jpg", "121800200_bef08fae5f.jpg", "121971540_0a986ee176.jpg", "1220401002_3f44b1f3f7.jpg", "1222322358_225067636e.jpg", "1224851143_33bcdd299c.jpg", "1225443522_1633e7121f.jpg", "1227655020_b11a1bb112.jpg", "1229756013_94663527d7.jpg", "1231229740_8dcbf80bfb.jpg", "1232148178_4f45cc3284.jpg", "1234293791_6566284bcd.jpg", "1234817607_924893f6e1.jpg", "1235580648_7eebaed9bc.jpg", "1235681222_819231767a.jpg", "1235685934_be89b231fb.jpg", "1236951314_0308dc4138.jpg", "1236964638_1808784a3c.jpg", "1237985362_dbafc59280.jpg", "123889082_d3751e0350.jpg", "123997871_6a9ca987b1.jpg", "1240297429_c36ae0c58f.jpg", "124195430_d14028660f.jpg"],
    # Dataset 3
    ["1244140539_da4804d828.jpg", "1244306891_8e78ae1620.jpg", "1244485675_822e6efe60.jpg", "1245022983_fb329886dd.jpg", "1247181182_35cabd76f3.jpg", "1248357227_2b4175fc39.jpg", "1248734482_3038218f3b.jpg", "124881487_36e668145d.jpg", "1248940539_46d33ed487.jpg", "1248953128_24c9f8d924.jpg", "124972799_de706b6d0b.jpg", "1251558317_4ef844b775.jpg", "1252396628_eb81d3905b.jpg", "1252787177_4b08625897.jpg", "125319704_49ead3463c.jpg", "1253264731_e7c689eca5.jpg", "1253275679_e955fb7304.jpg", "1255504166_f2437febcb.jpg", "1258913059_07c613f7ff.jpg", "1259936608_e3f0064f23.jpg", "1260816604_570fc35836.jpg", "1262077938_8b9516c273.jpg", "1262454669_f1caafec2d.jpg", "1262583859_653f1469a9.jpg", "1263126002_881ebd7ac9.jpg", "1263801010_5c74bf1715.jpg", "1267711451_e2a754b4f8.jpg", "1269470943_ba7fc49b4d.jpg", "1271210445_7f7ecf3791.jpg", "1271960365_e54033f883.jpg", "1273001772_1585562051.jpg", "127450902_533ceeddfc.jpg", "127488876_f2d2a89588.jpg", "127490019_7c5c08cb11.jpg", "1277185009_06478dd457.jpg", "1277743944_f4e8c78403.jpg", "1280147517_98767ca3b3.jpg", "1280320287_b2a4b9b7bd.jpg", "1282392036_5a0328eb86.jpg", "12830823_87d2654e31.jpg", "1285067106_2adc307240.jpg", "1285874746_486731a954.jpg", "1286408831_05282582ed.jpg", "1287064529_aa4e4f3c31.jpg", "1287073593_f3d2a62455.jpg", "1287475186_2dee85f1a5.jpg", "1287920676_d21a0b289b.jpg", "1287931016_fb015e2e10.jpg", "1287982439_6578006e22.jpg", "1288909046_d2b2b62607.jpg", "128912885_8350d277a4.jpg", "1289142574_2bd6a082dd.jpg", "1290894194_8a4ffdc7eb.jpg", "1294578091_2ad02fea91.jpg", "1295669416_21cabf594d.jpg", "1295671216_cde1b9c9d1.jpg", "1295698260_e10c53c137.jpg", "129599450_cab4e77343.jpg", "1296412797_85b6d2f8d6.jpg", "1296770308_3db2022f5a.jpg", "1298295313_db1f4c6522.jpg", "1298866571_b4c496b71c.jpg", "1299459550_1fd5594fa2.jpg", "1299459562_ed0e064aee.jpg", "1301140633_046e4e8010.jpg", "130211457_be3f6b335d.jpg", "1302657647_46b36c0d66.jpg", "1303335399_b3facd47ab.jpg", "1303548017_47de590273.jpg", "1303550623_cb43ac044a.jpg", "1303727066_23d0f6ed43.jpg", "1303727828_d1052ee341.jpg", "1304100320_c8990a1539.jpg", "1304961697_76b86b0c18.jpg", "1305564994_00513f9a5b.jpg", "1306145560_1e37081b91.jpg", "1307635496_94442dc21a.jpg", "1308472581_9961782889.jpg", "1308617539_54e1a3dfbe.jpg", "1309330801_aeeb23f1ee.jpg", "1311132744_5ffd03f831.jpg", "1311388430_4ab0cd1a1f.jpg", "1312020846_5abb4a9be2.jpg", "1312227131_771b5ed201.jpg", "1312954382_cf6d70d63a.jpg", "1313693129_71d0b21c63.jpg", "1313961775_824b87d155.jpg", "1316247213_1d2c726dd5.jpg", "131632409_4de0d4e710.jpg", "1317292658_ba29330a0b.jpg", "1319634306_816f21677f.jpg", "1321723162_9d4c78b8af.jpg", "1321949151_77b77b4617.jpg", "1322323208_c7ecb742c6.jpg", "1324816249_86600a6759.jpg", "132489044_3be606baf7.jpg", "1329832826_432538d331.jpg", "1330645772_24f831ff8f.jpg", "133189853_811de6ab2a.jpg", "1332208215_fa824f6659.jpg"],
    # Dataset 4
    ["1332492622_8c66992b62.jpg", "1332722096_1e3de8ae70.jpg", "1332815795_8eea44375e.jpg", "1332823164_c70a5d930e.jpg", "1333888922_26f15c18c3.jpg", "1334892555_1beff092c3.jpg", "1335617803_4fbc03dab0.jpg", "1337792872_d01a390b33.jpg", "1338523142_57fce8229b.jpg", "133905560_9d012b47f3.jpg", "1339596997_8ac29c1841.jpg", "1341787777_4f1ebb1793.jpg", "1342766791_1e72f92455.jpg", "1342780478_bacc32344d.jpg", "1343426964_cde3fb54e8.jpg", "1346051107_9cdc14e070.jpg", "1346529555_e916816cfe.jpg", "134724228_30408cd77f.jpg", "1347519824_e402241e4f.jpg", "1348113612_5bfc5f429e.jpg", "1348304997_afe60a61df.jpg", "1348891916_ebd4413033.jpg", "134894450_dadea45d65.jpg", "1348947380_14f0fc1237.jpg", "1348957576_c4a78eb974.jpg", "1350811702_2ce7cfd0c5.jpg", "1350948838_fdebe4ff65.jpg", "1351315701_6580b51c41.jpg", "1351764581_4d4fb1b40f.jpg", "135235570_5698072cd4.jpg", "1352398363_9cc8ffcce9.jpg", "1352410176_af6b139734.jpg", "1354318519_2f9baed754.jpg", "1355450069_c0675b0706.jpg", "1355703632_5683a4b6fb.jpg", "1355833561_9c43073eda.jpg", "1355935187_2c99648138.jpg", "1355945307_f9e01a9a05.jpg", "1356543628_c13ebe38fb.jpg", "1356796100_b265479721.jpg", "1357689954_72588dfdc4.jpg", "1357724865_4faf4e1418.jpg", "1357753846_6185e26040.jpg", "1358089136_976e3d2e30.jpg", "1358892595_7a37c45788.jpg", "1359101233_16c2c150e3.jpg", "1361420539_e9599c60ae.jpg", "1362128028_8422d53dc4.jpg", "1363843090_9425d93064.jpg", "1363924449_487f0733df.jpg", "136552115_6dc3e7231c.jpg", "136639119_6040b00946.jpg", "136644343_0e2b423829.jpg", "136644885_f7d2bbf546.jpg", "1368338041_6b4077ca98.jpg", "1368383637_614646cc4a.jpg", "136886677_6026c622eb.jpg", "1370615506_2b96105ca3.jpg", "1370773415_967b1ffde1.jpg", "1377668044_36398401dd.jpg", "1378557186_4bd1da6834.jpg", "1379026456_153fd8b51b.jpg", "1383698008_8ac53ed7ec.jpg", "1383840121_c092110917.jpg", "1384292980_4022a7520c.jpg", "1386251841_5f384a0fea.jpg", "1386964743_9e80d96b05.jpg", "138705546_be7a6845dd.jpg", "138718600_f430ebca17.jpg", "1387443857_602ab6f9bf.jpg", "1387461595_2fe6925f73.jpg", "1387785218_cee67735f5.jpg", "1388346434_524d0b6dfa.jpg", "1388373425_3c72b56639.jpg", "1388970365_162edcceb4.jpg", "1389264266_8170bc1c54.jpg", "1389323170_d1c81d6b51.jpg", "1389651420_8d95d8f6ed.jpg", "1390268323_2c8204e91c.jpg", "1392272228_cf104086e6.jpg", "1394368714_3bc7c19969.jpg", "1394396709_65040d97ab.jpg", "1394599090_fe0ba238f0.jpg", "1394620454_bf708cc501.jpg", "1394927474_0afdd82fc4.jpg", "1396064003_3fd949c9dd.jpg", "1396703063_e8c3687afe.jpg", "1397295388_8a5b6b525d.jpg", "1397887419_e798697b93.jpg", "1397923690_d3bf1f799e.jpg", "1398606571_f543f7698a.jpg", "1398613231_18de248606.jpg", "1398873613_7e3174dd6c.jpg", "1400424834_1c76e700c4.jpg", "1401961581_76921a75c5.jpg", "1402640441_81978e32a9.jpg", "1402641725_5e027ecaa7.jpg", "1402843760_d30f1dbf0f.jpg", "1402859872_0fc8cf8108.jpg", "1403414927_5f80281505.jpg"],
    # Dataset 5
    ["140377584_12bdbdf2f8.jpg", "140430106_2978fda105.jpg", "1404832008_68e432665b.jpg", "1405221276_21634dcd58.jpg", "140526326_da07305c1c.jpg", "140526327_3cb984de09.jpg", "1406010299_5755339f08.jpg", "1408958345_68eea9a4e4.jpg", "1410193619_13fff6c875.jpg", "141139674_246c0f90a1.jpg", "141140165_9002a04f19.jpg", "1412832223_99e8b4701a.jpg", "1413956047_c826f90c8b.jpg", "1414779054_31946f9dfc.jpg", "1414820925_3504c394e1.jpg", "1415591512_a84644750c.jpg", "1417031097_ab656bc4bd.jpg", "1417295167_5299df6db8.jpg", "141755290_4b954529f3.jpg", "141755292_7a0b3364cf.jpg", "1417637704_572b4d6557.jpg", "1417882092_c94c251eb3.jpg", "1417941060_2a0f7908bc.jpg", "1418019748_51c7d59c11.jpg", "1418266617_b32143275b.jpg", "1418503947_953d373632.jpg", "1419286010_b59af3962a.jpg", "1419385780_1383ec7ba9.jpg", "1420060020_7a6984e2ea.jpg", "1420060118_aed262d606.jpg", "1423126855_6cd2a3956c.jpg", "1423997242_ea2189ec5e.jpg", "1424237335_b3be9920ba.jpg", "1424775129_ffea9c13ab.jpg", "1425013325_bff69bc9da.jpg", "1425069308_488e5fcf9d.jpg", "1425069590_570cc7c2d8.jpg", "1425485485_d7c97a5470.jpg", "1425919702_ddb761aeec.jpg", "1426014905_da60d72957.jpg", "1427391496_ea512cbe7f.jpg", "142802798_962a4ec5ce.jpg", "1428578577_82864facae.jpg", "1428641354_f7453afbea.jpg", "1428681303_04213524e3.jpg", "1429546659_44cb09cbe2.jpg", "1429723917_6af585e4c0.jpg", "1429814475_0b592b9995.jpg", "1430154945_71bbaa094a.jpg", "1432179046_8e3d75cf81.jpg", "1432342377_3e41603f26.jpg", "143237785_93f81b3201.jpg", "1433088025_bce2cb69f8.jpg", "1433142189_cda8652603.jpg", "1433397131_8634fa6664.jpg", "1433577867_39a1510c43.jpg", "1434005938_ad75c8598c.jpg", "1434607942_da5432c28c.jpg", "143552697_af27e9acf5.jpg", "143552829_72b6ba49d4.jpg", "1436760519_8d6101a0ed.jpg", "143680442_2f03f76944.jpg", "143680966_0010ff8c60.jpg", "143684568_3c59299bae.jpg", "143688205_630813a466.jpg", "143688283_a96ded20f1.jpg", "143688895_e837c3bc76.jpg", "1439046601_cf110a75a7.jpg", "1439282131_3814d6ae04.jpg", "1440024115_129212c988.jpg", "1443807993_aebfb2784a.jpg", "1445123245_c7b9db0e0c.jpg", "1445754124_647168f211.jpg", "1446053356_a924b4893f.jpg", "1446933195_8fe9725d62.jpg", "1448511770_1a4a9c453b.jpg", "1449370354_380c4123c9.jpg", "1449625950_fc9a8d02d9.jpg", "1449692616_60507875fb.jpg", "1452361926_6d8c535e32.jpg", "1453366750_6e8cf601bf.jpg", "1454678644_7e5a371301.jpg", "1454841725_4b6e6199e2.jpg", "1456393634_74022d9056.jpg", "1456630952_dd4778a48f.jpg", "145721496_687af9bb18.jpg", "145721498_a27d2db576.jpg", "1457762320_7fe121b285.jpg", "1459032057_97e73ed6ab.jpg", "1459250022_bf1eddad11.jpg", "1460352062_d64fb633e0.jpg", "1460500597_866fa0c6f3.jpg", "146098876_0d99d7fb98.jpg", "146100443_906d87faa2.jpg", "1461329041_c623b06e5b.jpg", "1461653394_8ab96aae63.jpg", "1461667284_041c8a2475.jpg", "1463638541_c02cfa04dc.jpg", "1463732130_a754441289.jpg", "1463732807_0cdf4f22c7.jpg"]
]

text_similarity_results = []
image_similarity_results = []

for dataset_idx, image_names in enumerate(dataset_image_names):
    dataset_name = f"Dataset {dataset_idx + 1}"
    
    total_text_similarity = 0
    total_captions = 0

    for image_name in image_names:
        image_captions = captions_df[captions_df['file_name'] == image_name]['caption'].tolist()
        text_inputs = processor(text=[input_text] + image_captions, return_tensors="pt", padding=True).to(device)
        text_features = model.get_text_features(**text_inputs)
        input_embedding = text_features[0]
        caption_embeddings = text_features[1:]
        similarities = torch.nn.functional.cosine_similarity(input_embedding.unsqueeze(0), caption_embeddings, dim=1)
        total_text_similarity += similarities.mean().item()
        total_captions += len(image_captions)

    average_text_similarity = total_text_similarity / len(image_names)
    text_similarity_results.append({
        "dataset": dataset_name,
        "average_text_similarity": average_text_similarity
    })

    total_image_similarity = 0

    for image_name in image_names:
        image_path = os.path.join(image_folder, image_name)
        target_image = load_image(image_path)
        similarity = lpips_loss_fn(input_image, target_image).item()
        total_image_similarity += similarity

    average_image_similarity = total_image_similarity / len(image_names)
    image_similarity_results.append({
        "dataset": dataset_name,
        "average_image_similarity": average_image_similarity
    })

with open("3k_img1_text_similarity.json", "w") as f:
    json.dump(text_similarity_results, f, indent=4)

with open("3k_img1_image_similarity.json", "w") as f:
    json.dump(image_similarity_results, f, indent=4)

print("Analysis complete. Results saved to text_similarity_results.json and image_similarity_results.json.")
